Software Compensation of Magnetic Crosstalk on Hall-Effect-based
Rotary Encoders Close Together*
Guillaume Walck
1
and Veronique Perdereau
1
Abstract—In the process of developing human-like robotic
hands, engineers are looking for robust and accurate sensors
that can ﬁt in very conﬁned spaces. Rotary encoders that
measure joint angles of a multi-ﬁngered hand must be of very
small size and yet provide reliable and repetitive data. Hall-
effect sensors combined with ring magnets ﬁt in narrow spaces
and have proved to be durable rotary magnetic position sensors
duetotheircontact-lessfeatures.However,whenseveralsensors
of this kind are packed closely together in a ﬁnger, magnetic
crosstalk effects appear and can lead to important errors/shifts
in nearby sensor readings. This paper describes magnetic
crosstalk effects in nearby joints and proposes a compensation
method directly linked with the software calibration process.
I. INTRODUCTION
Measuring angular positions in robotics and more gen-
erally in industrial applications was solved with different
types of sensors over the decades ranging from rotational
potentiometers to optical sensors, from relative to absolute
encoders. In robotic hand design, integrating an angular
sensor into small-sized ﬁngers is challenging. Potentiome-
ters do not ﬁt in the narrow phalanxes but solution based
on optical sensors were proposed [1], [2]. However, these
sensors are either inﬂuenced by ambient light [1] or add
constraintsforthelightpath[2].Smallerthanopticalsensors,
the Hall-effect-based rotary encoders used in the Shadow
Dexterous robotic hand [3] completely ﬁt inside the ﬁnger
joints and are made absolute encoders by a combination of
a permanent magnet and a Hall-effect sensor. Like optical
encoders, they are not subject to friction and hence are more
durable. Unfortunately, they suffer from one principal and
known issue: their non-linearity. The Hall-effect sensor itself
is also subject to drifts due to temperature variations but
less than their resistive counter-parts. The magnetic sensing
devices have evolved a lot [4]–[7] with different packages
proposed to compensate intrinsic drawbacks, by integrating
one or more Hall-effect cells, geometrically well placed,
or by adding temperature measurement cells in the circuit
directly. Moreover, the non-linearity of sensors in general,
is now largely compensated with many possible solutions
in different categories: (i) analog solutions that directly
apply an inverse transfer function to provide an overall
linear characteristic [8], (ii) ROM-based look-up tables and
calibration techniques [9], [10] and (iii) advanced calibration
algorithms [11], up to neural-network-based solutions [12].
*The research leading to these results has been supported by the HAN-
DLE project (www.handle-project.eu), which has received funding from
the European Community’s Seventh Framework Program (FP7/2007-2013)
under grant agreement: ICT 231640
1
University Pierre and Marie Curie, 75005 Paris, France
veronique.perdereau at upmc.fr
The problem treated in this paper deals with a less
common disadvantage of these sensors that was encountered
within the European project HANDLE. This project tackles
the problem of in-hand manipulation with an anthropomor-
phic hand. The Shadow robotic hand used in the project is
composed of 5 human-sized ﬁngers (Fig. 1), each enclosing
four Hall-effect-based rotary encoders. Some of the sensors
showperturbing magnetic crosstalk effectsduetotheclosely-
packed magnets within different individual joints. This issue
is particularly important when very small movements are
required to perform ﬁne in-hand manipulation. However, the
problem is more generic and can appear in other devices
using those kind of sensors working close together such as
in an advanced joystick mentioned in [12].
Fig. 1. Shadow Dexterous Hand used in the HANDLE project
Section II proposes a detailed description of the problem
and explains the existing calibration technique used by
the manufacturer. In section III, the novel compensation
technique is described and a calibration process using visual
markers is detailed. Results and comparison with the existing
calibration method are given in section IV before section V
concludes the paper.
II. DESCRIPTION OF THE PROBLEM
The main advantage of rotary encoders based on magnetic
effects is their contact-less characteristic. Nevertheless, the
magnetic ﬁeld produced in such sensors, useful to their
function, can become a perturbation ﬁeld, interacting at a
distance with other elements in a close range. The magnetic
crosstalk effects appear when other elements in the range are
sensitive to the residual ﬁeld.
A. Sensors closely packed
The Shadow Dexterous hand is one of the most advanced
robotic hand in the world with a total of 24 degrees of
freedom (Fig. 2) and 20 motors (or 40 muscles in the
pneumatic version). The device mimics the kinematics and
2014 IEEE International Conference on Robotics & Automation (ICRA)
Hong Kong Convention and Exhibition Center
May 31 - June 7, 2014. Hong Kong, China
978-1-4799-3684-7/14/$31.00 ©2014 IEEE 4906
THJ2 is static and THJ1 moves, THJ2 is seen as moving by
the system and vice-versa. The reason for that is the design
of the existing calibration system relying on a single sensor
and detailed here after.
B. Current calibration method
Shadow Robot Company provides a ROS EtherCAT driver
for their hand. Their driver (sr edc ethercat driver) is respon-
sible for transmitting data back and forth between the hand
(palm ﬁrmware) and the software (realtime loop) on the host
on which the device is connected. Angle measurements are
transmitted at 1kHz as raw values coming from the Hall-
effect sensors and converted through 12 bits ADCs (values
between0and4095).Thecalibrationtotrueanglesinradians
is done inside the realtime loop using a calibration method
based on look-up tables.
In fact, the calibration method performs a step-wise inter-
polationbetween5referencepointsreadfromalook-uptable
for each joint (Fig. 5). Calibration jigs permit to calibrate
the joints, carefully creating the look-up table for each joint.
None of the joints travel more than 90 degrees and the
placement of the ring magnets is done such that the working
zone is in the most linear part of the range (red on Fig. 5).
Therefore the non-linearity is small and 5 points over the
range has proven to be sufﬁcient to keep the approximation
error small. Without any perturbation and with some noise
ﬁltering, the precision of the calibrated rotary encoders is
better than ±0.5 degrees.
0 40 80 120 160 200 240 280 320 360
degrees of rotation
Hall effect sensor raw ADC
0
4095
useful range
ADC angle
3200 0
2921 22.5
2535 45
2110 67.5
1591 90
Fig. 5. Hall-effect sensor typical response with usesul range in red and
step-wise linear interpolation in blue (left), look-up table example (right)
However, this method does not take into account the
possible magnetic crosstalk perturbation of the adjacent
joint although it is predictable. Indeed, the method relies
only on the reading of the associated sensor and has no
information about other movements of joints that inﬂuence
its measurements.
The existing method leads to measurement errors up to 8
degreesinsomejoints,whichisunacceptableforﬁnein-hand
manipulation. With no possibility to modify the hardware, a
new calibration technique, based on the reading of the 2
adjacent sensors was developed and is detailed in the next
section.
III. CALIBRATION AND COMPENSATION
This section develops a solution for compensating the
magnetic crosstalk effect on 2 adjacent joints and proposes
a mean to implement it using a visual calibration technique.
To solve our problem, we took the advantage of having a
host-side calibration for all the joints together rather than a
ﬁrmware and/or chip-based calibration per joint. Indeed, the
fact that all the Hall-effect sensors raw values are read at the
same instant (iteration of the 1 kHz loop) makes it possible
to do more complex computation on the complete set of
data. The processing power and available memory to store
larger look-up tables or compute inverse cosine functions
was not an issue at all. Even if a large neural-network could
be used to compensate all the effects (between two adjacent
joints or adjacent ﬁngers) with a method similar to [12], the
proposed solution handles each ﬁnger separately since the
largestcrosstalkeffectsareonlyonadjacentjointsJ1/J2.Two
adjacent sensors are processed to compensate the inﬂuence
of one magnet on the second sensor and vice versa.
A. Physical model
Let us present the problem related to the physics of
magnetic interaction. We suppose the ring magnets can be
represented as perfect magnetic dipoles with a magnetic
moment
~
M
i
. Figure 6 shows the magnetic ﬁeld
~
B
i
seen at
point P
i
by one of the ring magnet. The Hall-effect sensor
measures the ﬁeld in one direction only, along the segment
O
i
P
i
. One must consider B
r,i
, the projection of
~
B
i
on this
segment. ? i
is the joint angle chosen by Shadow Robot.
? i
P
i
? i
~
M
i
B
r,i
B
?,i
O
i
N
S
Fig. 6. Magnetic ﬁeld created by a ring magnet equivalent to a dipole
In polar coordinates (? i
,r
i
), B
r,i
depends on the distance
r
i
from the center O
i
and on the angle ? i
with the magnetic
moment as expressed in the following equation:
B
r,i
=C
i
2cos(? i
)
r
3
i
=C
i
2sin(? i
)
r
3
i
(1)
with constant C
i
depending on moment
~
M
i
and vacuum
permeability µ
0
, since permanent magnets are used.
Considering a pair of magnets placed in the same con-
ﬁguration as on adjacent joints in the robot hand, we can
derive the magnetic ﬁeld at point P
2
, center of the Hall-
effect sensor of joint 2, as the sum B
r
of the inﬂuence of
the 2 magnets (Fig. 7). B
r,1
and B
r,2
are the projections of
the magnetic ﬁeld of each magnet on the axis linking both
joints, and depend each one on the angle and radius to their
4908
? 2
P
2
P
1
? 2
~
M
2
B
r,2
? 1
? +? 1
~
M
1
B
r,1
r
2
r
1
r
1
r
2
Fig. 7. Magnetic ﬁeld created by 2 adjacent ring magnets
respective magnetic moments. Resulting ﬁeld B
r
|
P2
at P
2
is then:
B
r
|
P2
=C
2
2sin(? 2
)
r
3
2
  C
1
2sin(? 1
)
r
3
1
(2)
withC
1
andC
2
the constants depending on the ring magnets
characteristics. Even if there are other phenomena that were
ignored (printed board circuit and screws in the regions of
the magnet), we clearly have a Hall-effect sensor reading
dependent on both angles. Because the sensor placement is
symmetrical, the relation is true at both sensor centers, so
we also have:
B
r
|
P1
=C
1
2sin(? 1
)
r
3
2
  C
2
2sin(? 2
)
r
3
1
(3)
To simplify the notation, we note h
1
(resp. h
2
) the value
of B
r
|
P1
(resp. B
r
|
P2
) measured by the Hall-effect sensors
atP
1
(resp.P
2
). We extract? 1
and? 2
from Eq. 2 and Eq. 3:
sin(? 2
)=
?
h
2
+
2C
1
sin(? 1
)
r
3
1
?
r
3
2
2C
2
(4)
sin(? 1
)=
?
h
1
+
2C
2
sin(? 2
)
r
3
1
?
r
3
2
2C
1
(5)
As mentioned earlier, the measurements of both sensors are
available at the same time. It is then possible to express the
angles by combining equations Eq. 4 and Eq. 5:
? 1
=arcsin
0
B @ 0
B @ 1
1  ?
r2
r1
?
6
1
C A (a
1
h
1
+a
2
h
2
)
1
C A (6)
with a
1
=
r
3
2
2C1
and a
2
=
r
6
2
2C1r
3
1
.
A similar expression can be found for ? 2
:
? 2
=arcsin
0
B @ 0
B @ 1
1  ?
r2
r1
?
6
1
C A (a
3
h
2
+a
4
h
1
)
1
C A (7)
with a
3
=
r
3
2
2C2
and a
4
=
r
6
2
2C2r
3
1
.
Finally, we managed to get a relationship between a joint
measurement and 2 adjacent sensor readings, taking into
account the mutual inﬂuence of the packed pair of magnets.
However, to compute the angles effectively, all the constants
should be known. There is no easy mean to precisely extract
each single constant, but a parameter ﬁtting method based
on real measurements and reference values can solve this
problem.
B. Model-based approach
The host side calibration software can easily compute the
angle values through a model. Since the exact model (Eq. 6,
Eq. 7) is non-linear, we checked several approximated linear
models with increasing complexity from 3 to 7 parameters
perjoint,andtriedtoﬁndtheparametersviaaﬁttingmethod.
For each case, we considered a linear regression ﬁtted with
the least squares approach.
1) Linear model: Knowing that ? 1
(resp. ? 2
) builds up
as the sum of 2 sensor values led us to ﬁrst coarsely approx-
imate the equations with a linear model with 3 parameters
per joint:
? =c
0
+c
1
h
1
+c
2
h
2
(8)
2) Polynomial models: To add complexity, several poly-
nomial models were tested such as this example:
? =c
0
+c
1
h
1
+c
2
h
2
+c
3
h
3
1
+c
4
h
3
2
(9)
5 parameters are required per joint in this model.
3) Taylor series decomposition model: A more precise
approximated model comes from the Taylor series of the
trigonometric function arcsin:
arcsin(x)=
1 X
n=0
(2n)!
4
n
(n!)
2
(2n+1)
x
2n+1
for |x |< 1 (10)
The 2nd-degree Taylor polynomial of arcsin gives a poly-
nomial model of degree 3:
arcsin(x)? 1+x+
x
3
6
(11)
By replacing x=(h
1
+h
2
) we obtain a new model:
? =c
0
+c
1
h
1
+c
2
h
2
+c
3
h
3
1
+c
4
h
3
2
+c
5
h
2
h
2
1
+c
6
h
1
h
2
2
(12)
It includes crossed-terms and leads to 7 parameters per joint.
To get good results in the linear regressions with our
different models, the number of ground-truth values must
be important, even more when the number of parameters to
ﬁnd is high. Obtaining those reference values is described in
the next subsection.
C. Ground-truth extraction
A large number of reference points must be extracted to
correctly ﬁt the model. We remind that only 5 calibration
jigs are provided per joints, which means 25 points can be
measured theoretically for 2 adjacent joints. Unfortunately,
the calibration jigs were not designed to ﬁt simultaneously
on the joints as they both use the same leaning surfaces to be
accurately placed. So a new technique had to be proposed,
not using the jigs and preferably providing more points.
A visual reference angle extraction method was created,
usingthejointcenterscrewsasmarkersforacircleextraction
technique.The anglesbetweenthelinesconnectingthecircle
centers give the joint angles. Such a method is robust to the
placementofthecameraiftheimageplaneisroughlyparallel
to the ﬁnger plane and if the ﬁnger is close to the center of
the image. The existing screws are not all shiny and easy to
segment, so, some color markers were added in a ﬁrst step,
4909
directly over the screw heads, making it easier to distinguish
their centers (Fig. 3).
The processing chain is shown in ﬁgure 8 and was
implemented in OpenCV [13]. In an initialization phase, the
color HSV
gray
inrange thresh
morph
mask
& blur
Canny
Hough
Circles track angles
dilate &
sat threshold
clicked
color
color distance
S H
unused V
p1 p2
min size max size
max dist
clicked positions
Fig. 8. Angle extraction processing chain
user clicks the color markers on the joints in the correct
order. Thanks to a color segmentation on the hue channel
in hue-saturation-value (HSV) color-space, a dilated mask is
created and applied to the gray image to get a perfect circle
contour extraction through a Canny ﬁlter (p1 and p2 are the
ﬁlter hysteresis thresholds). The Hough transform for circles
is applied to get the circle centers for a radius in a given
range. Tracking of the circles is done to keep the same order
and association of the centers with the joint numbers. The
joint angles between connected centers are then computed
(Fig. 9).
(a) (b) (c) (d) (e)
Fig. 9. Processing example: (a) color segmentation, (b) morphology close,
(c) dilated mask on grayscale, (d) Canny ﬁlter, (e) ﬁnal result after tracking
The obtained angles have been checked against the cali-
bration jigs and are correct within ±0.5 degrees when the
segmentation and ﬁlter parameters are tuned properly. When
used simultaneously, the calibration jigs do not offer a better
precision whereas our method can virtually provide as many
reference points as required. With this method, data from 60
positions were extracted, covering the entire range of both J1
and J2 joints, essentially by moving each joint independently
for several ﬁxed positions of the adjacent joints. Both raw
values and reference angles were stored to be processed by
the model-ﬁtting method.
D. Model-ﬁtting
To extract the model parameters, we used a model-ﬁtting
technique. Basically, we solve the system for N samples per
joint. Let us illustrate the algorithm with the ﬁrst polynomial
model (Eq. 9) on ? 1
:
8 >< >: ? 1,1
= c
0
+c
1
h
1,1
+c
2
h
2,1
+c
3
h
3
1,1
+c
4
h
3
2,1
.
.
. =
.
.
.
? 1,N
= c
0
+c
1
h
1,N
+c
2
h
2,N
+c
3
h
3
1,N
+c
4
h
3
2,N
(13)
The regression was implemented thanks to a matrix format.
We obtain: 2
6 4
? 1,1
.
.
.
? 1,N
3
7 5 =H.
2
6 4
c
0
.
.
.
c
4
3
7 5 (14)
with,
H =
2
6 4
1 h
1,1
h
2,1
h
3
1,1
h
3
2,1
.
.
.
.
.
.
.
.
.
.
.
.
.
.
.
1 h
1,N
h
2,N
h
3
1,N
h
3
2,N
3
7 5 (15)
Then,
C=[c
0
,···,c
4
]
>
=H
†
.[? 1,1
,···,? 1,N
]
>
(16)
withH
†
the pseudo-inverse ofH.
Once the parametersC are computed, they are saved in
a conﬁguration ﬁle to be used by the driver. The calibration
function integrated in the main loop of the driver was
modiﬁed to apply the selected model to the calibration of
each pair of adjacent joints.
IV. RESULTS AND COMPARISON
Figure 10 shows how one of our models ﬁts well on angle
J1referencevaluescomparedtotheShadowcalibrationwhen
J2 was static at 38.5 degrees. The differences are mainly at
theextremepartsoftherange,betterﬁttedbyourpolynomial
model with higher degree and cross-terms. The coefﬁcients
c
0
,···,c
6
found for this example are 1.8,  7.1? 10
  4
,7.2? 10
  4
,0.52,  9.7,  1.9? 10
  3
,3.0? 10
  3
.
In order to evaluate the results, two criteria were used:
• determination coefﬁcient R
2
over the model-ﬁtting
• amplitude and mean errors in the sensor range
First the models were compared with respect to the determi-
nation coefﬁcient, measuring how close the model is from
the recorded data (1.0 being a perfect match). Table II gives
R
2
for each model.
Naturally, the model from the Taylor series, derived from
the physics of magnetic interaction, achieves the best ﬁtting
results. Other polynomial models not including crossed-
terms do not improve the result. For every model, the
4910
